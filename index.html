<!DOCTYPE html>
<html>
<head>
	<title>Editor</title>
	<link rel="stylesheet" type="text/css" href="style.css" />
	<script src="http://cdnjs.cloudflare.com/ajax/libs/knockout/2.3.0/knockout-min.js"></script>
	<script src="https://rawgithub.com/jDataView/jDataView/master/src/jdataview.js"></script>
	<script src="https://rawgithub.com/jDataView/jBinary/master/src/jbinary.js"></script>
	<script>
	ko.bindingHandlers.file = {
		init: function (element, valueAccessor) {
			valueAccessor = valueAccessor();

			valueAccessor(element.files[0]);
			element.addEventListener('change', function () {
				valueAccessor(this.files[0]);
			});
		}
	};

	var viewModel = {
		file: ko.observable(),
		typeSet: ko.observable(),
		binary: ko.observable(),
		current: ko.observable(),
		items: ko.observableArray(),
		moveCurrent: function (viewModel, event) {
			var current = viewModel.current(),
				delta = 0;

			// all browsers || Chrome
			switch (event.key || event.keyIdentifier) {
				case 'Up':
					delta = -32;
					break;

				case 'Down':
					delta = 32;
					break;

				case 'Left':
					delta = -1;
					break;

				case 'Right':
					delta = 1;
					break;

				case 'PageUp':
					delta = -512;
					break;

				case 'PageDown':
					delta = 512;
					break;

				default:
					return true;
			}

			current += delta;
			if (delta < 0) {
				if (current < 0) {
					current = 0;
				}
			} else {
				var max = viewModel.binary().view.byteLength - 1;
				if (current > max) {
					current = max;
				}
			}

			viewModel.current(current);
		},
		clickCurrent: function (viewModel, event) {
			if ('offset' in event.target.dataset) viewModel.current(Number(event.target.dataset.offset));
		},
		toHex: function (number, length) {
			var s = number.toString(16).toUpperCase();
			while (s.length < length) {
				s = '0' + s;
			}
			return s;
		},
		splitBy: function (array, count) {
			var list = [];
			for (var i = 0, length = array.length; i < length; i += count) {
				list.push({
					offset: i,
					chunk: (array.slice || array.subarray).call(array, i, i + count)
				});
			}
			return list;
		},
		isElementInViewport: function (el) {
			var rect = el.getBoundingClientRect();

			return (
				rect.top >= 0 &&
				rect.left >= 0 &&
				rect.bottom <= (window.innerHeight || document. documentElement.clientHeight) &&
				rect.right <= (window.innerWidth || document. documentElement.clientWidth)
			);
		}
	};

	ko.computed(function () {
		var file = viewModel.file(), typeSet = viewModel.typeSet();

		if (!file) return;

		jBinary.loadData(file, function (err, data) {
			viewModel.binary(new jBinary(data, typeSet));
			viewModel.getItems(50);
			viewModel.current(0);
		});
	});

	var oldCurrent;

	viewModel.current.subscribe(function (value) {
		oldCurrent = value;
	}, this, 'beforeChange');

	viewModel.current.subscribe(function (value) {
		(function selectCurrent() {
			var newElement = document.querySelector('#binary .value[data-offset="' + value + '"]');
			if (!newElement) return setTimeout(selectCurrent, 100);
			var oldElement = document.querySelector('#binary .current');
			if (oldElement) {
				oldElement.classList.remove('current');
			}
			newElement.classList.add('current');
			if (!viewModel.isElementInViewport(newElement)) {
				newElement.scrollIntoView(value > oldCurrent);
			}
		})();
	});

	viewModel.items.offset = 0;
	viewModel.scrolled = function(data, event) {
		var elem = event.target;
		if (elem.scrollTop > (elem.scrollHeight - elem.offsetHeight - 20 * 18)) {
			viewModel.getItems(20);
		}
	};

	viewModel.getItems = function (cnt) {
		var binary = viewModel.binary(),
			items = viewModel.items,
			data = viewModel.binary().read(['blob', Math.min(32 * cnt, binary.view.byteLength - items.offset)], items.offset);

		for (var i = 0; i < cnt; i++) {
			var offset = 32 * i;
			items.push({
				offset: items.offset + offset,
				chunk: (data.slice || data.subarray).call(data, offset, offset + 32)
			});
		}
		items.offset += 32 * cnt;
	}

	addEventListener('load', function () {
		ko.applyBindings(viewModel);
	});
	</script>
</head>
<body>
	<div id="toolbar">
		<input type="file" id="file" data-bind="file: file" />
		<div id="position" data-bind="if: current() !== undefined">
			Position:
			0x<span data-bind="text: $root.toHex(current(), 8)"></span>
			(<span data-bind="text: current"></span>)
		</div>
	</div>
	<div id="binary" tabindex="1" data-bind="foreach: items, event: {keydown: moveCurrent, click: clickCurrent, scroll: scrolled}">
		<div>
			<span class="offset" data-bind="text: $root.toHex(offset, 8)"></span>:
			<span data-bind="foreach: chunk">
				<span class="value" data-bind="attr: {'data-offset': $parent.offset + $index()}, text: $root.toHex($data, 2)"></span>
			</span>
		</div>
	</div>
</body>
</html>